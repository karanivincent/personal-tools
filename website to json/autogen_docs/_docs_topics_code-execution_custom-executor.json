{
    "url": "https://microsoft.github.io/autogen/docs/topics/code-execution/custom-executor",
    "title": "Custom Code Executor",
    "sections": [
        {
            "title": "",
            "content": [
                {
                    "text": "\n\nIn this guide we will show you how to create a custom code executor that\nruns code inside the same Jupyter notebook as this one.\n\nFirst, let’s install the required dependencies:"
                },
                {
                    "code": {
                        "language": "python",
                        "script": "! pip\n-\nqqq install pyautogen matplotlib yfinance"
                    }
                },
                {
                    "code": {
                        "language": "python",
                        "script": "import\nos\nfrom\ntyping\nimport\nList\nfrom\nIPython\nimport\nget_ipython\nfrom\nautogen\nimport\nConversableAgent\nfrom\nautogen\n.\ncoding\nimport\nCodeBlock\n,\nCodeExecutor\n,\nCodeExtractor\n,\nCodeResult\n,\nMarkdownCodeExtractor"
                    }
                },
                {
                    "text": "Now we can create the custom code executor class by subclassing the\nCodeExecutor\nprotocol and implementing the\nexecute_code_blocks\nmethod."
                },
                {
                    "code": {
                        "language": "python",
                        "script": "class\nNotebookExecutor\n(\nCodeExecutor\n)\n:\n@property\ndef\ncode_extractor\n(\nself\n)\n-\n>\nCodeExtractor\n:\n# Extact code from markdown blocks.\nreturn\nMarkdownCodeExtractor\n(\n)\ndef\n__init__\n(\nself\n)\n-\n>\nNone\n:\n# Get the current IPython instance running in this notebook.\nself\n.\n_ipython\n=\nget_ipython\n(\n)\ndef\nexecute_code_blocks\n(\nself\n,\ncode_blocks\n:\nList\n[\nCodeBlock\n]\n)\n-\n>\nCodeResult\n:\nlog\n=\n\"\"\nfor\ncode_block\nin\ncode_blocks\n:\nresult\n=\nself\n.\n_ipython\n.\nrun_cell\n(\n\"%%capture --no-display cap\\n\"\n+\ncode_block\n.\ncode\n)\nlog\n+=\nself\n.\n_ipython\n.\nev\n(\n\"cap.stdout\"\n)\nlog\n+=\nself\n.\n_ipython\n.\nev\n(\n\"cap.stderr\"\n)\nif\nresult\n.\nresult\nis\nnot\nNone\n:\nlog\n+=\nstr\n(\nresult\n.\nresult\n)\nexitcode\n=\n0\nif\nresult\n.\nsuccess\nelse\n1\nif\nresult\n.\nerror_before_exec\nis\nnot\nNone\n:\nlog\n+=\nf\"\\n\n{\nresult\n.\nerror_before_exec\n}\n\"\nexitcode\n=\n1\nif\nresult\n.\nerror_in_exec\nis\nnot\nNone\n:\nlog\n+=\nf\"\\n\n{\nresult\n.\nerror_in_exec\n}\n\"\nexitcode\n=\n1\nif\nexitcode\n!=\n0\n:\nbreak\nreturn\nCodeResult\n(\nexit_code\n=\nexitcode\n,\noutput\n=\nlog\n)"
                    }
                },
                {
                    "text": "Now we can use the new custom code executor in our agents."
                },
                {
                    "code": {
                        "language": "python",
                        "script": "code_writer_agent\n=\nConversableAgent\n(\nname\n=\n\"CodeWriter\"\n,\nsystem_message\n=\n\"You are a helpful AI assistant.\\n\"\n\"You use your coding skill to solve problems.\\n\"\n\"You have access to a IPython kernel to execute Python code.\\n\"\n\"You can suggest Python code in Markdown blocks, each block is a cell.\\n\"\n\"The code blocks will be executed in the IPython kernel in the order you suggest them.\\n\"\n\"All necessary libraries have already been installed.\\n\"\n\"Once the task is done, returns 'TERMINATE'.\"\n,\nllm_config\n=\n{\n\"config_list\"\n:\n[\n{\n\"model\"\n:\n\"gpt-4\"\n,\n\"api_key\"\n:\nos\n.\ngetenv\n(\n\"OPENAI_API_KEY\"\n)\n}\n]\n}\n,\n)\ncode_executor_agent\n=\nConversableAgent\n(\nname\n=\n\"CodeExecutor\"\n,\nllm_config\n=\nFalse\n,\ncode_execution_config\n=\n{\n\"executor\"\n:\nNotebookExecutor\n(\n)\n}\n,\nis_termination_msg\n=\nlambda\nmsg\n:\n\"TERMINATE\"\nin\nmsg\n.\nget\n(\n\"content\"\n,\n\"\"\n)\n.\nstrip\n(\n)\n.\nupper\n(\n)\n,\n)"
                    }
                },
                {
                    "text": "Let’s use the agents to complete a simple task of drawing a plot showing\nthe market caps of the top 7 publicly listed companies."
                },
                {
                    "code": {
                        "language": "python",
                        "script": "chat_result\n=\ncode_executor_agent\n.\ninitiate_chat\n(\ncode_writer_agent\n,\nmessage\n=\n\"Create a plot showing the market caps of the top 7 publicly listed companies using data from Yahoo Finance.\"\n,\n)"
                    }
                },
                {
                    "code": {
                        "language": "text",
                        "script": "CodeExecutor\n(\nto\nCodeWriter\n)\n:\nCreate a plot showing the market caps of the top 7 publicly listed companies using data from Yahoo Finance.\n--------------------------------------------------------------------------------\n>>>>>>>> USING AUTO REPLY...\nCodeWriter\n(\nto\nCodeExecutor\n)\n:\nTo accomplish this task, we would use the `yfinance` library to fetch data from Yahoo Finance, `pandas` library for data manipulation, and `matplotlib` for data visualization.\nSteps:\n1. Identify the tickers for the top 7 largest publicly listed companies. Currently, these companies are: Apple (AAPL), Microsoft (MSFT), Google (GOOGL), Amazon (AMZN), Facebook (FB), Tesla (TSLA), and Berkshire Hathaway (BRK-A).\n2. Fetch market cap information for these companies using yfinance.\n3. Clean and process the fetched data into a usable format (a pandas DataFrame).\n4. Plot the market caps for these companies.\nLet's start by fetching data for these companies.\n--------------------------------------------------------------------------------\n>>>>>>>> USING AUTO REPLY...\nCodeExecutor\n(\nto\nCodeWriter\n)\n:\n--------------------------------------------------------------------------------\n>>>>>>>> USING AUTO REPLY...\nCodeWriter\n(\nto\nCodeExecutor\n)\n:\nGreat! Before I continue, I need to know if the necessary libraries are installed.\nThe libraries needed for this task are:\n1. `yfinance`\n2. `pandas`\n3. `matplotlib`\nIf these libraries are not installed, you can install them using pip:\n```python\n!pip install yfinance pandas matplotlib\n```\nAssuming these libraries are installed, we would import them and proceed with fetching the market cap data:\n```python\nimport yfinance as yf\nimport pandas as pd\nimport matplotlib.pyplot as plt\n# Define tickers\ntickers = [\"AAPL\", \"MSFT\", \"GOOGL\", \"AMZN\", \"FB\", \"TSLA\", \"BRK-A\"]\n# Fetch data\ndata = yf.download(tickers, start=\"2022-02-01\", end=\"2022-02-28\")\n# Extract only 'Close' values for each ticker\ndata = data['Close']\n# Create empty dictionary to hold market cap data\nmarket_caps = {}\n# Calculate market caps\nfor ticker in tickers:\ninfo = yf.Ticker(ticker).info\nmarket_caps[ticker] = info[\"marketCap\"]\n# Convert market_caps dictionary to pandas DataFrame\ndf = pd.DataFrame(list(market_caps.items()), columns=['Company', 'Market_Cap'])\n# Sort DataFrame by Market_Cap in descending order\ndf = df.sort_values('Market_Cap', ascending=False)\n# Plot data\nplt.figure(figsize=(10,6))\nplt.barh(df['Company'], df['Market_Cap'], color='skyblue')\nplt.xlabel('Market Cap (in trillions)')\nplt.title('Market Caps of Top 7 Publicly Listed Companies')\nplt.gca().invert_yaxis()\nplt.show()\n```\nPlease note that the start and end dates used while fetching data specifies the time period we are interested in. Feel free to modify these as needed. The 'marketCap' obtained from the 'info' property of the Ticker object represents the market cap as of the end date.\nAlso note that the final plot shows the companies in descending order of market cap, with the company with the highest market cap at the top of the chart.\n--------------------------------------------------------------------------------\n>>>>>>>> USING AUTO REPLY...\n>>>>>>>> EXECUTING 2 CODE BLOCKS (inferred languages are [python, python])...\nCodeExecutor\n(\nto\nCodeWriter\n)\n:\nexitcode: 0 (execution succeeded)\nCode output: Requirement already satisfied: yfinance in /Users/ekzhu/miniconda3/envs/autogen/lib/python3.11/site-packages (0.2.36)\nRequirement already satisfied: pandas in /Users/ekzhu/miniconda3/envs/autogen/lib/python3.11/site-packages (2.2.1)\nRequirement already satisfied: matplotlib in /Users/ekzhu/miniconda3/envs/autogen/lib/python3.11/site-packages (3.8.3)\nRequirement already satisfied: numpy>=1.16.5 in /Users/ekzhu/miniconda3/envs/autogen/lib/python3.11/site-packages (from yfinance) (1.26.4)\nRequirement already satisfied: requests>=2.31 in /Users/ekzhu/miniconda3/envs/autogen/lib/python3.11/site-packages (from yfinance) (2.31.0)\nRequirement already satisfied: multitasking>=0.0.7 in /Users/ekzhu/miniconda3/envs/autogen/lib/python3.11/site-packages (from yfinance) (0.0.11)\nRequirement already satisfied: lxml>=4.9.1 in /Users/ekzhu/miniconda3/envs/autogen/lib/python3.11/site-packages (from yfinance) (5.0.1)\nRequirement already satisfied: appdirs>=1.4.4 in /Users/ekzhu/miniconda3/envs/autogen/lib/python3.11/site-packages (from yfinance) (1.4.4)\nRequirement already satisfied: pytz>=2022.5 in /Users/ekzhu/miniconda3/envs/autogen/lib/python3.11/site-packages (from yfinance) (2023.3.post1)\nRequirement already satisfied: frozendict>=2.3.4 in /Users/ekzhu/miniconda3/envs/autogen/lib/python3.11/site-packages (from yfinance) (2.4.0)\nRequirement already satisfied: peewee>=3.16.2 in /Users/ekzhu/miniconda3/envs/autogen/lib/python3.11/site-packages (from yfinance) (3.17.0)\nRequirement already satisfied: beautifulsoup4>=4.11.1 in /Users/ekzhu/miniconda3/envs/autogen/lib/python3.11/site-packages (from yfinance) (4.12.2)\nRequirement already satisfied: html5lib>=1.1 in /Users/ekzhu/miniconda3/envs/autogen/lib/python3.11/site-packages (from yfinance) (1.1)\nRequirement already satisfied: python-dateutil>=2.8.2 in /Users/ekzhu/miniconda3/envs/autogen/lib/python3.11/site-packages (from pandas) (2.8.2)\nRequirement already satisfied: tzdata>=2022.7 in /Users/ekzhu/miniconda3/envs/autogen/lib/python3.11/site-packages (from pandas) (2023.4)\nRequirement already satisfied: contourpy>=1.0.1 in /Users/ekzhu/miniconda3/envs/autogen/lib/python3.11/site-packages (from matplotlib) (1.2.0)\nRequirement already satisfied: cycler>=0.10 in /Users/ekzhu/miniconda3/envs/autogen/lib/python3.11/site-packages (from matplotlib) (0.12.1)\nRequirement already satisfied: fonttools>=4.22.0 in /Users/ekzhu/miniconda3/envs/autogen/lib/python3.11/site-packages (from matplotlib) (4.47.2)\nRequirement already satisfied: kiwisolver>=1.3.1 in /Users/ekzhu/miniconda3/envs/autogen/lib/python3.11/site-packages (from matplotlib) (1.4.5)\nRequirement already satisfied: packaging>=20.0 in /Users/ekzhu/miniconda3/envs/autogen/lib/python3.11/site-packages (from matplotlib) (23.2)\nRequirement already satisfied: pillow>=8 in /Users/ekzhu/miniconda3/envs/autogen/lib/python3.11/site-packages (from matplotlib) (10.2.0)\nRequirement already satisfied: pyparsing>=2.3.1 in /Users/ekzhu/miniconda3/envs/autogen/lib/python3.11/site-packages (from matplotlib) (3.1.1)\nRequirement already satisfied: soupsieve>1.2 in /Users/ekzhu/miniconda3/envs/autogen/lib/python3.11/site-packages (from beautifulsoup4>=4.11.1->yfinance) (2.5)\nRequirement already satisfied: six>=1.9 in /Users/ekzhu/miniconda3/envs/autogen/lib/python3.11/site-packages (from html5lib>=1.1->yfinance) (1.16.0)\nRequirement already satisfied: webencodings in /Users/ekzhu/miniconda3/envs/autogen/lib/python3.11/site-packages (from html5lib>=1.1->yfinance) (0.5.1)\nRequirement already satisfied: charset-normalizer<4,>=2 in /Users/ekzhu/miniconda3/envs/autogen/lib/python3.11/site-packages (from requests>=2.31->yfinance) (3.3.2)\nRequirement already satisfied: idna<4,>=2.5 in /Users/ekzhu/miniconda3/envs/autogen/lib/python3.11/site-packages (from requests>=2.31->yfinance) (3.6)\nRequirement already satisfied: urllib3<3,>=1.21.1 in /Users/ekzhu/miniconda3/envs/autogen/lib/python3.11/site-packages (from requests>=2.31->yfinance) (1.26.18)\nRequirement already satisfied: certifi>=2017.4.17 in /Users/ekzhu/miniconda3/envs/autogen/lib/python3.11/site-packages (from requests>=2.31->yfinance) (2024.2.2)\n/Users/ekzhu/miniconda3/envs/autogen/lib/python3.11/site-packages/yfinance/utils.py:775: FutureWarning: The 'unit' keyword in TimedeltaIndex construction is deprecated and will be removed in a future version. Use pd.to_timedelta instead.\ndf.index += _pd.TimedeltaIndex(dst_error_hours, 'h')\n/Users/ekzhu/miniconda3/envs/autogen/lib/python3.11/site-packages/yfinance/utils.py:775: FutureWarning: The 'unit' keyword in TimedeltaIndex construction is deprecated and will be removed in a future version. Use pd.to_timedelta instead.\ndf.index += _pd.TimedeltaIndex(dst_error_hours, 'h')\n[**************        29%%                      ]  2 of 7 completed/Users/ekzhu/miniconda3/envs/autogen/lib/python3.11/site-packages/yfinance/utils.py:775: FutureWarning: The 'unit' keyword in TimedeltaIndex construction is deprecated and will be removed in a future version. Use pd.to_timedelta instead.\ndf.index += _pd.TimedeltaIndex(dst_error_hours, 'h')\n[********************* 43%%                      ]  3 of 7 completed/Users/ekzhu/miniconda3/envs/autogen/lib/python3.11/site-packages/yfinance/utils.py:775: FutureWarning: The 'unit' keyword in TimedeltaIndex construction is deprecated and will be removed in a future version. Use pd.to_timedelta instead.\ndf.index += _pd.TimedeltaIndex(dst_error_hours, 'h')\n[**********************57%%*                     ]  4 of 7 completed/Users/ekzhu/miniconda3/envs/autogen/lib/python3.11/site-packages/yfinance/utils.py:775: FutureWarning: The 'unit' keyword in TimedeltaIndex construction is deprecated and will be removed in a future version. Use pd.to_timedelta instead.\ndf.index += _pd.TimedeltaIndex(dst_error_hours, 'h')\n[**********************71%%********              ]  5 of 7 completed/Users/ekzhu/miniconda3/envs/autogen/lib/python3.11/site-packages/yfinance/utils.py:775: FutureWarning: The 'unit' keyword in TimedeltaIndex construction is deprecated and will be removed in a future version. Use pd.to_timedelta instead.\ndf.index += _pd.TimedeltaIndex(dst_error_hours, 'h')\n[*********************100%%**********************]  7 of 7 completed\n1 Failed download:\n['FB']: Exception('%ticker%: No timezone found, symbol may be delisted')\n--------------------------------------------------------------------------------\n>>>>>>>> USING AUTO REPLY...\nCodeWriter\n(\nto\nCodeExecutor\n)\n:\nFrom the error message, it seems that the 'FB' ticker (Facebook) failed to download because it might have been delisted. This is likely due to Facebook's corporate rebranding to Meta Platforms Inc. in late 2021, which resulted in a ticker change from 'FB' to 'META'.\nTo resolve this, we'll replace 'FB' in our tickers list with 'META' and then retrieve the data again. Here is the modified code:\n```python\n# Define tickers\ntickers = [\"AAPL\", \"MSFT\", \"GOOGL\", \"AMZN\", \"META\", \"TSLA\", \"BRK-A\"]\n# Fetch data\ndata = yf.download(tickers, start=\"2022-02-01\", end=\"2022-02-28\")\n# Extract only 'Close' values for each ticker\ndata = data['Close']\n# Create empty dictionary to hold market cap data\nmarket_caps = {}\n# Calculate market caps\nfor ticker in tickers:\ninfo = yf.Ticker(ticker).info\nmarket_caps[ticker] = info[\"marketCap\"]\n# Convert market_caps dictionary to pandas DataFrame\ndf = pd.DataFrame(list(market_caps.items()), columns=['Company', 'Market_Cap'])\n# Sort DataFrame by Market_Cap in descending order\ndf = df.sort_values('Market_Cap', ascending=False)\n# Plot data\nplt.figure(figsize=(10,6))\nplt.barh(df['Company'], df['Market_Cap'], color='skyblue')\nplt.xlabel('Market Cap (in trillions)')\nplt.title('Market Caps of Top 7 Publicly Listed Companies')\nplt.gca().invert_yaxis()\nplt.show()\n```\n--------------------------------------------------------------------------------\n>>>>>>>> USING AUTO REPLY...\n>>>>>>>> EXECUTING CODE BLOCK (inferred language is python)...\nCodeExecutor\n(\nto\nCodeWriter\n)\n:\nexitcode: 0 (execution succeeded)\nCode output: /Users/ekzhu/miniconda3/envs/autogen/lib/python3.11/site-packages/yfinance/utils.py:775: FutureWarning: The 'unit' keyword in TimedeltaIndex construction is deprecated and will be removed in a future version. Use pd.to_timedelta instead.\ndf.index += _pd.TimedeltaIndex(dst_error_hours, 'h')\n/Users/ekzhu/miniconda3/envs/autogen/lib/python3.11/site-packages/yfinance/utils.py:775: FutureWarning: The 'unit' keyword in TimedeltaIndex construction is deprecated and will be removed in a future version. Use pd.to_timedelta instead.\ndf.index += _pd.TimedeltaIndex(dst_error_hours, 'h')\n[                       0%%                      ]/Users/ekzhu/miniconda3/envs/autogen/lib/python3.11/site-packages/yfinance/utils.py:775: FutureWarning: The 'unit' keyword in TimedeltaIndex construction is deprecated and will be removed in a future version. Use pd.to_timedelta instead.\ndf.index += _pd.TimedeltaIndex(dst_error_hours, 'h')\n/Users/ekzhu/miniconda3/envs/autogen/lib/python3.11/site-packages/yfinance/utils.py:775: FutureWarning: The 'unit' keyword in TimedeltaIndex construction is deprecated and will be removed in a future version. Use pd.to_timedelta instead.\ndf.index += _pd.TimedeltaIndex(dst_error_hours, 'h')\n[********************* 43%%                      ]  3 of 7 completed/Users/ekzhu/miniconda3/envs/autogen/lib/python3.11/site-packages/yfinance/utils.py:775: FutureWarning: The 'unit' keyword in TimedeltaIndex construction is deprecated and will be removed in a future version. Use pd.to_timedelta instead.\ndf.index += _pd.TimedeltaIndex(dst_error_hours, 'h')\n[**********************57%%*                     ]  4 of 7 completed/Users/ekzhu/miniconda3/envs/autogen/lib/python3.11/site-packages/yfinance/utils.py:775: FutureWarning: The 'unit' keyword in TimedeltaIndex construction is deprecated and will be removed in a future version. Use pd.to_timedelta instead.\ndf.index += _pd.TimedeltaIndex(dst_error_hours, 'h')\n[**********************71%%********              ]  5 of 7 completed/Users/ekzhu/miniconda3/envs/autogen/lib/python3.11/site-packages/yfinance/utils.py:775: FutureWarning: The 'unit' keyword in TimedeltaIndex construction is deprecated and will be removed in a future version. Use pd.to_timedelta instead.\ndf.index += _pd.TimedeltaIndex(dst_error_hours, 'h')\n[*********************100%%**********************]  7 of 7 completed\n--------------------------------------------------------------------------------\n>>>>>>>> USING AUTO REPLY...\nCodeWriter\n(\nto\nCodeExecutor\n)\n:\nI see that the fetched data was successfully retrieved and processed. However, it looks like the result of the plot isn't visible, so we don't know whether the plot was generated successfully. Please run the code again and provide the output of the plot.\nIf there are any issues or any other points you would like me to help with, let me know!\n--------------------------------------------------------------------------------\n>>>>>>>> USING AUTO REPLY...\nCodeExecutor\n(\nto\nCodeWriter\n)\n:\n--------------------------------------------------------------------------------\n>>>>>>>> USING AUTO REPLY...\nCodeWriter\n(\nto\nCodeExecutor\n)\n:\nI'm glad we were able to retrieve and process the data successfully. Please try running the last part of the code again to generate and display the plot:\n```python\n# Plot data\nplt.figure(figsize=(10,6))\nplt.barh(df['Company'], df['Market_Cap'], color='skyblue')\nplt.xlabel('Market Cap (in trillions)')\nplt.title('Market Caps of Top 7 Publicly Listed Companies')\nplt.gca().invert_yaxis()\nplt.show()\n```\nThis section of the code creates a horizontal bar plot of the market capitalizations of the companies. The `plt.gca().invert_yaxis()` line is included to invert the y-axis, so the company with the highest market cap is at the top of the chart.\n--------------------------------------------------------------------------------\n>>>>>>>> USING AUTO REPLY...\n>>>>>>>> EXECUTING CODE BLOCK (inferred language is python)...\nCodeExecutor\n(\nto\nCodeWriter\n)\n:\nexitcode: 0 (execution succeeded)\nCode output:\n--------------------------------------------------------------------------------\n>>>>>>>> USING AUTO REPLY...\nCodeWriter\n(\nto\nCodeExecutor\n)\n:\nI see that the code has executed successfully, but unfortunately, the generated plot is not visible here. However, given that there are no errors, it's likely that the plot has been created as expected when you executed the code on your end.\nIf you have any other questions related to this code or need further assistance with Python coding or data visualization, please let me know! I'm here to help.\nOtherwise, if this completes your initial request, I will end this task. Just let me know your decision.\n--------------------------------------------------------------------------------\n>>>>>>>> USING AUTO REPLY...\nCodeExecutor\n(\nto\nCodeWriter\n)\n:\n--------------------------------------------------------------------------------\n>>>>>>>> USING AUTO REPLY...\nCodeWriter\n(\nto\nCodeExecutor\n)\n:\nAlright. If you have any more questions regarding this task, or if you need help with other tasks in the future, don't hesitate to ask. Have a great day!\n'---\nTERMINATE\n---'\n--------------------------------------------------------------------------------"
                    }
                },
                {
                    "code": {
                        "language": "text",
                        "script": "KeyError: 'marketCap'"
                    }
                },
                {
                    "text": "\n\n\n\nYou can see the plots are now displayed in the current notebook."
                }
            ],
            "subsections": []
        }
    ],
    "images": []
}